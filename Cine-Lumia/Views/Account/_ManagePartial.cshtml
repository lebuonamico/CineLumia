@model Cine_Lumia.Models.ManageViewModel

<div class="d-flex align-items-center justify-content-center mb-4">
    <div class="avatar-carousel">
        <button id="prev-avatar" type="button" class="avatar-nav-btn prev"><i class="bi bi-arrow-left-circle"></i></button>
        <img src="~/img/avatar/@Model.Avatars[Model.IdAvatar - 1]" alt="Avatar" class="profile-avatar" id="avatar-image">
        <button id="next-avatar" type="button" class="avatar-nav-btn next"><i class="bi bi-arrow-right-circle"></i></button>
    </div>
</div>

<form asp-action="Manage" method="post" data-ajax="true" data-ajax-method="POST" data-ajax-update="#genericModal .modal-body" data-ajax-mode="replace" data-ajax-success="onManageSuccess">
    <input type="hidden" id="IdAvatar" name="IdAvatar" value="@Model.IdAvatar" />
    <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>

    <h4 class="mb-3">Datos Personales</h4>
    <div class="mb-3">
        <label asp-for="Nombre" class="form-label"></label>
        <input asp-for="Nombre" class="form-control" />
        <span asp-validation-for="Nombre" class="text-danger"></span>
    </div>
    <div class="mb-3">
        <label asp-for="Apellido" class="form-label"></label>
        <input asp-for="Apellido" class="form-control" />
        <span asp-validation-for="Apellido" class="text-danger"></span>
    </div>
    <div class="mb-3">
        <label asp-for="Email" class="form-label"></label>
        <input asp-for="Email" class="form-control" />
        <span asp-validation-for="Email" class="text-danger"></span>
    </div>
    <div class="mb-3">
        <label asp-for="Dni" class="form-label"></label>
        <input asp-for="Dni" class="form-control" />
        <span asp-validation-for="Dni" class="text-danger"></span>
    </div>
    <div class="mb-3">
        <label asp-for="Alias" class="form-label"></label>
        <input asp-for="Alias" class="form-control" />
        <span asp-validation-for="Alias" class="text-danger"></span>
    </div>
    <div class="mb-3">
        <label asp-for="Telefono" class="form-label"></label>
        <input asp-for="Telefono" class="form-control" />
        <span asp-validation-for="Telefono" class="text-danger"></span>
    </div>
    <div class="mb-3">
        <label asp-for="FechaNacimiento" class="form-label"></label>
        <input asp-for="FechaNacimiento" type="date" class="form-control" />
        <span asp-validation-for="FechaNacimiento" class="text-danger"></span>
    </div>
    <div class="mb-3">
        <label asp-for="Genero" class="form-label"></label>
        <select asp-for="Genero" class="form-select">
            <option value="">Seleccionar Género</option>
            <option value="Hombre">Hombre</option>
            <option value="Mujer">Mujer</option>
            <option value="Otro">Otro</option>
        </select>
        <span asp-validation-for="Genero" class="text-danger"></span>
    </div>

    <hr class="my-4" />

    <h4 class="mb-3">Seguridad y Acceso</h4>
    <div class="d-flex justify-content-between mb-3">
        <a href="#" class="btn btn-outline-secondary modal-link" data-url="@Url.Action("ChangePasswordPartial", "Account")" data-title="Cambiar Contraseña">Cambiar Contraseña</a>
        <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#deleteAccountModal">Eliminar Cuenta</button>
    </div>

    <hr class="my-4" />

    <h4 class="mb-3">Métodos de Pago Guardados</h4>
    <div class="mb-3">
        <p class="text-muted">Aquí podrás ver y modificar tus tarjetas registradas. (Funcionalidad futura)</p>
        <button type="button" class="btn btn-outline-info" disabled>Gestionar Tarjetas</button>
    </div>

    <hr class="my-4" />

    <h4 class="mb-3">Historial y Configuración de Entradas</h4>
    <div class="mb-3">
        <p class="text-muted">Consulta tu historial de compras de entradas. (Funcionalidad futura)</p>
        <button type="button" class="btn btn-outline-info" disabled>Ver Historial de Compras</button>
    </div>

    <hr class="my-4" />
    
    <div class="d-grid">
        <button type="submit" class="btn btn-primary">Guardar Cambios</button>
    </div>
</form>

<script>
    // Script para el carrusel de avatares
    document.addEventListener('DOMContentLoaded', function () {
        const avatarImage = document.getElementById('avatar-image');
        const prevButton = document.getElementById('prev-avatar');
        const nextButton = document.getElementById('next-avatar');
        const idAvatarInput = document.getElementById('IdAvatar');

        const avatars = @Html.Raw(Json.Serialize(Model.Avatars));
        let currentAvatarIndex = @(Model.IdAvatar - 1);

        function updateAvatar() {
            avatarImage.src = `/img/avatar/${avatars[currentAvatarIndex]}`;
            idAvatarInput.value = currentAvatarIndex + 1;
        }

        prevButton.addEventListener('click', function () {
            currentAvatarIndex = (currentAvatarIndex - 1 + avatars.length) % avatars.length;
            updateAvatar();
        });

        nextButton.addEventListener('click', function () {
            currentAvatarIndex = (currentAvatarIndex + 1) % avatars.length;
            updateAvatar();
        });

        // Initial setup
        updateAvatar();
    });

    // Función para manejar el éxito de la gestión de cuenta (ej. cerrar modal y recargar página)
    function onManageSuccess(data) {
        if (data && data.success) { // You might need to adjust this based on your controller's JSON response
            location.reload(); // Reload the page to update navbar state and profile info
        } else {
            // If manage failed but ModelState was valid, the partial view itself will show errors
            // Re-parse validation scripts for the newly loaded content
            $.validator.unobtrusive.parse('#genericModal .modal-body');
        }
    }
</script>