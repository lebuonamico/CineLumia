@model IEnumerable<Cine_Lumia.Entities.CineConsumible>

@{
    ViewData["Title"] = "Snacks disponibles por cine";
    var agrupado = Model
    .Where(c => c != null && c.Cine != null)
    .GroupBy(c => c.Cine.Nombre)
    .ToList();

}
@{
    string modo = ViewBag.Modo ?? "Normal";
}

@if (modo == "Asientos")
{
    <form method="post" action="/Consumibles/VolverAAsientos">
        <button class="btn-volver-top">
            <i class="bi bi-arrow-left"></i> Volver
        </button>
    </form>
    <form method="get" action="/Pago/Index">
        <button type="button" class="btn-continuar-top" onclick="continuarAlPago()">
            Continuar al pago <i class="bi bi-arrow-right"></i>
        </button>
    </form>

}

<style>
    .btn-volver-top {
        position: fixed;
        top: 90px;
        left: 40px;
        display: flex;
        align-items: center;
        gap: 8px;
        background: rgba(0, 0, 0, 0.75);
        border: 1px solid #ff253c;
        color: #ff253c;
        font-weight: 600;
        font-size: 1rem;
        padding: 10px 22px;
        border-radius: 40px;
        cursor: pointer;
        z-index: 1050;
        transition: all 0.25s ease;
        backdrop-filter: blur(6px);
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
        text-decoration: none;
    }

        .btn-volver-top:hover {
            background: #ff253c;
            color: #fff;
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(255, 37, 60, 0.4);
        }

        .btn-volver-top i {
            font-size: 1.2rem;
        }
</style>
<style>
    .btn-continuar-top {
        position: fixed;
        top: 90px;
        right: 40px;
        align-items: center;
        gap: 8px;
        background: rgba(0, 0, 0, 0.75);
        border: 1px solid #28a745;
        color: #28a745;
        font-weight: 600;
        font-size: 1rem;
        padding: 10px 22px;
        border-radius: 40px;
        cursor: pointer;
        z-index: 1100;
        transition: all 0.25s ease;
        backdrop-filter: blur(6px);
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
        text-decoration: none;
        display: none; /* Oculto por defecto */
    }

        .btn-continuar-top:hover {
            background: #28a745;
            color: #fff;
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(40, 167, 69, 0.4);
        }

        .btn-continuar-top i {
            font-size: 1.2rem;
            z-index: 1000;
        }
    /* Offcanvas siempre por encima */
    .offcanvas {
        z-index: 1200 !important; /* asegurate que est√© encima de los botones fijos */
    }

</style>


<nav class="navbar navbar-expand-lg bg-body-tertiary">
    <div class="container-fluid">
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarSupportedContent">

            <form class="d-flex w-100 me-2" role="search" id="searchForm">
                <input class="form-control me-2 w-100" type="search" placeholder="Buscar snacks..." aria-label="Search" id="searchInput" style="font-size: 1.6rem;" />
                <button class="btn btn-outline-info btn-lg" type="submit">Buscar</button>
            </form>

        </div>
    </div>
</nav>

<h2 class="mt-4 mb-4 text-center">Tus Snacks Favoritos En un solo lugar</h2>

<div class="container-fluid">

    <div class="row">
        <div class="col-12">
            @foreach (var grupo in agrupado)
            {
                <div class="card mb-4 shadow-sm cine-section">
                    <div class="card-header bg-danger text-white">
                        <h4 class="mb-0">üçø @grupo.Key</h4>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            @foreach (var item in grupo)
                            {
                                <div class="col-md-3 mb-3 snack-item">
                                    <div class="card h-100">
                                        <img src="@(string.IsNullOrEmpty(item.Consumible.PosterUrl) ? Url.Content("~/images/snack_placeholder.png") : item.Consumible.PosterUrl)"
                                             class="card-img-top" alt="@item.Consumible.Nombre" />
                                        <div class="card-body d-flex flex-column">
                                            <h5 class="card-title snack-name">@item.Consumible.Nombre</h5>
                                            <p class="card-text flex-grow-1 snack-desc">@item.Consumible.Descripcion</p>
                                            <p class="card-text"><strong class="text-body-secondary">@item.Consumible.Precio.ToString("C")</strong></p>
                                            <button class="btn btn-sm btn-danger mt-2 btn-agregar-carrito btn-lg" style="font-size:1.70rem!important"
                                                    data-snack="@item.Consumible.Nombre"
                                                    data-precio="@item.Consumible.Precio"
                                                    data-stock="@item.Stock"
                                                    data-cine-id="@item.Id_Cine"
                                                    data-consumible-id="@item.Id_Consumible"
                                                    data-img-url="@item.Consumible.PosterUrl">
                                                +
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

<button id="burbuja-carrito"
        class="btn-burbuja-profesional"
        data-bs-toggle="offcanvas"
        data-bs-target="#CarritoOffcanvas"
        aria-controls="CarritoOffcanvas">
    Mi Compra üçø
    <span id="contador-carrito" class="badge-burbuja">
        0
    </span>
</button>


<div class="offcanvas offcanvas-end" tabindex="-1" id="CarritoOffcanvas" aria-labelledby="carritoLabel">
    <div class="offcanvas-header bg-danger text-white">
        <h5 class="offcanvas-title" id="carritoLabel">Mi Compra üçø</h5>
        <button type="button" class="btn-close btn-clos e-white" data-bs-dismiss="offcanvas" aria-label="Cerrar"></button>
    </div>
    <div class="offcanvas-body">

        <div id="carrito-vacio" class="text-center text-muted">
            <p>No hay items en el carrito</p>
        </div>

        <div id="carrito-items" style="display: none;">
        </div>

        <div id="carrito-total" class="mt-3" style="display: none;">
            <hr>
            <div class="d-flex justify-content-between">
                <strong>Total:</strong>
                <strong id="total-precio" class="text-white">$0.00</strong>
            </div>
            <button type="button" class="btn btn-outline-secondary w-100 mt-3 btn-lg" data-bs-dismiss="offcanvas">
                @(modo == "Asientos" ? "Seguir eligiendo" : "Seguir comprando")
            </button>


            @if (modo == "Asientos")
            {
                <button type="button" class="btn btn-danger btn-lg w-100 mt-4" onclick="enviarCarritoAPago()">
                    Ir al pago
                </button>
            }

            else
            {
                <button class="btn btn-danger w-100 mt-2 btn-lg" id="btn-finalizar-compra">
                    Finalizar compra
                </button>
            }

        </div>
    </div>
</div>
@if (modo == "Asientos")
{
    <form method="post" action="/Consumibles/FinalizarSnacks">
        <button type="submit" class="btn btn-danger btn-lg w-100 mt-4">
            Ir al pago
        </button>
    </form>
}


@section Scripts {
    <style>
        .btn-burbuja-profesional {
            position: fixed;
            bottom: 40px; /* sub√≠ un poco para que no tape los snacks */
            right: 40px; /* m√°s a la derecha para no tapar la grilla */
            width: 70px; /* un poquito m√°s peque√±o */
            height: 70px;
            font-size: 1.8rem;
            display: none;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #ff3d3d, #ff253c);
            border: none;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(255, 37, 60, 0.6);
            transition: transform 0.3s ease, box-shadow 0.3s ease, background 0.3s ease;
            z-index: 1080;
            color: #fff;
        }


        .btn-burbuja-profesional:hover {
            transform: scale(1.15);
            box-shadow: 0 10px 30px rgba(255, 37, 60, 0.8);
            background: linear-gradient(135deg, #ff5a5a, #ff1a2c);
        }

        .btn-burbuja-profesional:active {
            transform: scale(1);
            box-shadow: 0 5px 15px rgba(255, 37, 60, 0.7);
        }

        /* Contador de items */
        .badge-burbuja {
            position: absolute;
            top: 0;
            right: 0;
            transform: translate(50%, -50%);
            background: #ffc107;
            color: #000;
            font-weight: 700;
            border-radius: 50%;
            width: 36px; /* antes 28px */
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.4rem;
            box-shadow: 0 0 8px rgba(0,0,0,0.3);
        }

        /* Animaci√≥n de rebote (mantener) */
        @@keyframes rebote {
            0% { transform: translateY(0); }
            25% { transform: translateY(-12px); }
            50% { transform: translateY(0); }
            75% { transform: translateY(-6px); }
            100% { transform: translateY(0); }
        }

        .rebote {
            animation: rebote 0.5s ease;
        }
        /* Tarjeta de cada item en el carrito */
        .carrito-item-card {
            background: #1e1e1e; /* fondo oscuro */
            color: #fff; /* texto blanco */
            border-radius: 12px;
            padding: 10px 15px;
            margin-bottom: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.4);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

            /* Nombre del snack */
            .carrito-item-card .snack-nombre {
                font-size: 1rem;
                font-weight: 600;
                margin-bottom: 4px;
            }

            /* Precio de cada item m√°s visible */
            .carrito-item-card .snack-precio {
                font-size: 1.1rem;
                font-weight: 700;
                color: #fff; /* blanco para que se vea m√°s */
            }

            /* Botones de sumar/restar m√°s grandes */
            .carrito-item-card .btn-restar,
            .carrito-item-card .btn-sumar {
                font-size: 1.2rem;
                padding: 6px 12px;
                border-radius: 8px;
            }

            /* Cantidad en medio de los botones */
            .carrito-item-card .cantidad-item {
                min-width: 30px;
                text-align: center;
                font-weight: 600;
                color: #fff;
            }

        </style >

    <script>
        // Declaraci√≥n del array de carrito (mantenida)
        let carrito = [];

        // Elementos DOM para la burbuja y el carrito (agregados)
        const contadorCarritoDOM = document.getElementById('contador-carrito');
                // üî• botones que vamos a ocultar/mostrar
        const btnContinuarTop = document.querySelector('.btn-continuar-top');
        const btnBurbujaCarrito = document.getElementById('burbuja-carrito');

        // Funci√≥n para actualizar el contador de la burbuja (total de unidades)
        function actualizarContadorBurbuja() {
            const totalUnidades = carrito.reduce((sum, item) => sum + item.cantidad, 0);
            contadorCarritoDOM.textContent = totalUnidades;
            contadorCarritoDOM.style.display = totalUnidades > 0 ? 'block' : 'none';
        }

        document.addEventListener('DOMContentLoaded', function() {
            actualizarCarrito();
                    // ===========================
        // RESTAURAR CARRITO DESDE SESSION
        // ===========================
                               @if (modo == "Asientos" && ViewBag.CarritoSnacks != null)
        {
                <text>
                    carrito = [];
                    try {
                        let data = @Html.Raw(Json.Serialize(ViewBag.CarritoSnacks));
                        console.log("RAW SESSION DATA:", data);

                        if (data && data !== null && data !== "") {
                            carrito = JSON.parse(data);
                            carrito = carrito.map(x => ({
                                id: x.Id,
                                consumibleId: x.Id,
                                snack: x.Snack,
                                precio: Number(x.Precio),
                                cantidad: x.Cantidad,
                                cineId: x.CineId,
                                imagenUrl: x.ImagenUrl || "/images/snack_placeholder.png",
                                stock: 999
                            }));
                        }

                        console.log("CARRITO DESPU√âS DEL PARSEO:", carrito);

                    } catch (e) {
                        console.log("ERROR PARSEANDO SESSION:", e);
                        carrito = [];
                    }

                    actualizarCarrito();
                </text>
        }




            // ... (Resto de tus event listeners: agregar, finalizar compra, buscar)

            // Evento para agregar items al carrito (mantenido)
            document.querySelectorAll('.btn-agregar-carrito').forEach(boton => {
                boton.addEventListener('click', function() {
                    const snack = this.getAttribute('data-snack');
                    const precio = parseFloat(this.getAttribute('data-precio').replace(',', '.'));
                    const stock = parseInt(this.getAttribute('data-stock'));
                    const cineId = parseInt(this.getAttribute('data-cine-id'));
                    const consumibleId = parseInt(this.getAttribute('data-consumible-id'));

                    agregarAlCarrito({
                        id: consumibleId,
                        snack,
                        precio,
                        stock,
                        cineId,
                        consumibleId,
                        imagenUrl: this.getAttribute('data-img-url')
                    });
                });
            });

            // Evento para finalizar compra (mantenido)
                    const botonFinalizar = document.getElementById('btn-finalizar-compra');
        if (botonFinalizar) {
            botonFinalizar.addEventListener('click', finalizarCompra);
        }


            // Evento para el buscador (mantenido)
            document.getElementById('searchForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
                buscarSnacks(searchTerm);
            });

            // Evento para b√∫squeda en tiempo real (mantenido)
            document.getElementById('searchInput').addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase().trim();
                buscarSnacks(searchTerm);
            });

            // Inicializar al cargar
            actualizarCarrito();
        });

        // --- L√ìGICA DE B√öSQUEDA (MANTENIDA) ---
        function buscarSnacks(searchTerm) {
            const snackItems = document.querySelectorAll('.snack-item');
            const cineSections = document.querySelectorAll('.cine-section');

                    if (searchTerm === '') {
            snackItems.forEach(item => item.style.display = 'block');

            // si hay un solo cine, mostrarlo siempre
            if (cineSections.length === 1) {
                cineSections[0].style.display = 'block';
            } else {
                cineSections.forEach(section => section.style.display = 'block');
            }

            return;
        }


            let algunResultadoEncontrado = false;

            cineSections.forEach(section => {
                const snacksEnSection = section.querySelectorAll('.snack-item');
                let algunSnackVisibleEnSection = false;

                snacksEnSection.forEach(item => {
                    const snackName = item.querySelector('.snack-name').textContent.toLowerCase();
                    const snackDesc = item.querySelector('.snack-desc').textContent.toLowerCase();

                    if (snackName.includes(searchTerm) || snackDesc.includes(searchTerm)) {
                        item.style.display = 'block';
                        algunSnackVisibleEnSection = true;
                        algunResultadoEncontrado = true;
                    } else {
                        item.style.display = 'none';
                    }
                });

                        if (algunSnackVisibleEnSection) {
            section.style.display = 'block';
        } else {
            section.style.display = 'none';
        }

            });

            if (!algunResultadoEncontrado) {
                // ... (Manejo de "No se encontraron resultados" si lo necesitas)
            }
        }

        // --- L√ìGICA DE CARRITO (MANTENIDA Y MODIFICADA) ---
        function agregarAlCarrito(item) {
            const itemExistente = carrito.find(i => i.consumibleId === item.consumibleId && i.cineId === item.cineId);

            if (itemExistente) {
                if (itemExistente.cantidad < 10 && itemExistente.cantidad < item.stock) {
                    itemExistente.cantidad++;
                } else {
                    alert('‚ùå No se puede agregar m√°s de 10 unidades o no hay suficiente stock.');
                    return;
                }
            } else {
                if (carrito.length >= 20) { // L√≠mite de √≠tems diferentes m√°s razonable
                    alert('‚ùå M√°ximo 20 items diferentes en el carrito.');
                    return;
                }
                carrito.push({
                   id: item.id,               // debe coincidir con Id_Consumible
                    ...item,
                    cantidad: 1,
                    imagenUrl: item.imagenUrl   // agregamos la URL
                });
            }

            actualizarCarrito();
                    // Hacer que el bot√≥n de la burbuja rebote al agregar un snack
        btnBurbujaCarrito.classList.remove('rebote'); // reinicia la animaci√≥n
        void btnBurbujaCarrito.offsetWidth; // forzar reflow para reiniciar la animaci√≥n
        btnBurbujaCarrito.classList.add('rebote');

        }

        function actualizarCarrito() {
            const carritoItems = document.getElementById('carrito-items');
            const carritoVacio = document.getElementById('carrito-vacio');
            const carritoTotal = document.getElementById('carrito-total');
            const totalPrecio = document.getElementById('total-precio');

            // Actualizar la burbuja antes de salir
            actualizarContadorBurbuja();
                    // üî• Mostrar/ocultar bot√≥n "Continuar al pago"
        if (btnContinuarTop) {
            btnContinuarTop.style.display = carrito.length > 0 ? 'none' : 'flex';

        }

        // üî• Mostrar/ocultar burbuja Carrito
        if (btnBurbujaCarrito) {
            btnBurbujaCarrito.style.display = carrito.length > 0 ? 'block' : 'none';
        }

            if (carrito.length === 0) {
                carritoVacio.style.display = 'block';
                carritoItems.style.display = 'none';
                carritoTotal.style.display = 'none';
                return;
            }

            carritoVacio.style.display = 'none';
            carritoItems.style.display = 'block';
            carritoTotal.style.display = 'block';

            carritoItems.innerHTML = '';
            let total = 0;

            carrito.forEach((item, index) => {
                const subtotal = item.precio * item.cantidad;
                total += subtotal;

                        const itemHTML = `
        <div class="carrito-item-card">
            <div>
                <div class="snack-nombre">${item.snack}</div>
                <div class="snack-precio">$${subtotal.toFixed(2)}</div>
            </div>
            <div class="d-flex align-items-center gap-2">
                <button class="btn btn-outline-secondary btn-restar" data-index="${index}">-</button>
                <span class="cantidad-item">${item.cantidad}</span>
                <button class="btn btn-outline-secondary btn-sumar" data-index="${index}">+</button>
            </div>
        </div>
        `;

                carritoItems.innerHTML += itemHTML;
            });

            totalPrecio.textContent = `$${total.toFixed(2)}`;

            // Agregar eventos a los botones de los items renderizados
            document.querySelectorAll('.btn-restar').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    restarCantidad(index);
                });
            });

            document.querySelectorAll('.btn-sumar').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    sumarCantidad(index);
                });
            });
        }

        // --- L√ìGICA DE CANTIDAD Y FINALIZAR (MANTENIDA) ---
        function restarCantidad(index) {
            if (carrito[index].cantidad > 1) {
                carrito[index].cantidad--;
                actualizarCarrito();
            } else {
                carrito.splice(index, 1);
                actualizarCarrito();
            }
        }

                function sumarCantidad(index) {
            if (carrito[index].cantidad < 10 && carrito[index].cantidad < carrito[index].stock) {
                carrito[index].cantidad++;
                actualizarCarrito();

                // Rebote al sumar
                btnBurbujaCarrito.classList.remove('rebote');
                void btnBurbujaCarrito.offsetWidth;
                btnBurbujaCarrito.classList.add('rebote');
            } else {
                alert('‚ùå No se puede agregar m√°s de 10 unidades o no hay suficiente stock.');
            }
        }


        function finalizarCompra() {
            var isAuthenticated = @User.Identity.IsAuthenticated.ToString().ToLower();
            var hasCineSelectedInCart = carrito.length > 0 && carrito.every(item => item.cineId && item.cineId !== 0);

            if (!isAuthenticated || !hasCineSelectedInCart) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Por favor Inicie Sesion',
                    text: 'Tambi√©n seleccione su cine para Comprar',
                    customClass: {
                        popup: 'swal2-dark-popup',
                        confirmButton: 'swal2-confirm-red'
                    },
                    confirmButtonText: 'Aceptar'
                });
                return; // Stop the function execution
            }

            if (carrito.length === 0) {
                alert('‚ùå El carrito est√° vac√≠o.');
                return;
            }

            const comprasPorCine = {};
            carrito.forEach(item => {
                if (!comprasPorCine[item.cineId]) {
                    comprasPorCine[item.cineId] = [];
                }
                comprasPorCine[item.cineId].push({
                    consumibleId: item.consumibleId,
                    cantidad: item.cantidad
                });
            });

            const promises = Object.keys(comprasPorCine).map(cineId => {
                return fetch('/Consumibles/Comprar', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        // Aseg√∫rate de que el token exista en tu p√°gina si usas CSRF
                        'RequestVerificationToken': document.getElementsByName('__RequestVerificationToken')[0]?.value || ''
                    },
                    body: JSON.stringify({
                        cineId: parseInt(cineId),
                        items: comprasPorCine[cineId]
                    })
                });
            });

            Promise.all(promises)
                .then(async responses => {
                    let todosExitosos = true;
                    let mensaje = '';

                    for (let response of responses) {
                        if (!response.ok) {
                            if (response.status === 401) {
                                alert('üîê Debes iniciar sesi√≥n para comprar.');
                                return;
                            }
                            todosExitosos = false;
                            const data = await response.json().catch(() => null);
                            mensaje = data?.mensaje || '‚ùå Error al realizar la compra.';
                            break;
                        }
                    }

                    if (todosExitosos) {
                        Swal.fire({
                            icon: 'success',
                            title: 'Compra Exitosa',
                            text: 'Que lo disfrute',
                            customClass: {
                                popup: 'swal2-dark-popup',
                                confirmButton: 'swal2-confirm-red'
                            },
                            confirmButtonText: 'Aceptar'
                        }).then(() => {
                            carrito = [];
                            actualizarCarrito();
                            location.reload();
                        });
                    } else {
                        alert(mensaje); // Keep the regular alert for errors
                    }
                })
                .catch(() => {
                    alert('‚ùå Error al procesar la compra.');
                });
        }
                function enviarCarritoAPago() {
            fetch('/Consumibles/GuardarCarrito', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(carrito)
            })
            .then(r => {
                if (r.ok) window.location.href = '/Pago/Index';
                else alert("Error enviando el carrito");
            });
        }
                       function continuarAlPago() {
            // Vaciar carrito en JS
            carrito = [];
            actualizarCarrito();

            // Vaciar carrito en sesi√≥n en el servidor
            fetch('/Consumibles/GuardarCarrito', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(carrito)
            }).then(() => {
                // Redirigir al pago
                window.location.href = '/Pago/Index';
            });
        }


    </script>
}
