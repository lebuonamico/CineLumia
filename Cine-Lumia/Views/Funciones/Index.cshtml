@model Cine_Lumia.Models.ViewModel.FuncionesViewModel

<style>
    body {
        background: #0d0d0d !important;
        color: #fff !important;
        font-family: 'Segoe UI', sans-serif;
        margin: 0;
    }

    .backdrop {
        position: fixed;
        inset: 0;
        background-size: cover;
        background-position: center;
        filter: blur(40px) brightness(.25);
        z-index: -1;
    }

    .container {
        display: flex;
        gap: 40px;
        max-width: 1200px;
        margin: 50px auto;
        padding: 0 20px;
    }

    .left-panel {
        width: 340px;
        flex-shrink: 0;
    }

    .movie-poster {
        width: 100%;
        height: 510px;
        border-radius: 14px;
        object-fit: cover;
        box-shadow: 0 0 50px rgba(0,0,0,.9);
    }

    .movie-title {
        font-size: 2rem;
        font-weight: 700;
        margin-top: 20px;
    }

    .details {
        color: #cfcfcf;
        margin-top: 6px;
    }

    .right-panel {
        flex: 1;
        display: flex;
        flex-direction: column;
        max-height: 600px; /* altura máxima visible */
        overflow-y: auto; /* scroll solo en esta columna */
        padding-right: 10px;
    }

    .date-selector a {
        padding: 10px 18px;
        border-radius: 8px;
        text-decoration: none;
        border: 1px solid #ff253c;
        color: #ff253c;
        font-weight: 600;
        transition: .25s;
        display: inline-block;
        margin: 4px;
    }

    .date-selector a.active,
    .date-selector a:hover {
        background: #ff253c;
        color: #fff;
    }

    .sala-title {
        font-size: 1.2rem;
        font-weight: 600;
        margin-top: 20px;
        margin-bottom: 8px;
        text-transform: uppercase;
    }

    .horarios-container {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin-bottom: 20px;
    }

    .hour-button {
        padding: 10px 20px;
        border-radius: 40px;
        border: 1px solid #ff253c;
        font-weight: 600;
        background: #0a0a0a;
        color: #ffffff;
        cursor: pointer;
        transition: .25s;
    }

    .hour-button:hover,
    .hour-button.selected {
        background: #ff253c;
        color: #fff;
        transform: scale(1.05);
    }

    .buy-button {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        padding: 18px 0;
        background: #ff253c;
        color: #fff;
        text-align: center;
        font-size: 1.4rem;
        font-weight: 700;
        border: none;
        cursor: pointer;
        display: none;
        transition: .25s;
        z-index: 999;
    }

    .buy-button:hover {
        background: #e81e34;
    }

    .btn-volver-top {
        position: fixed;
        top: 90px;
        left: 40px;
        display: flex;
        align-items: center;
        gap: 8px;
        background: rgba(0, 0, 0, 0.75);
        border: 1px solid #ff253c;
        color: #ff253c;
        font-weight: 600;
        font-size: 1rem;
        padding: 10px 22px;
        border-radius: 40px;
        cursor: pointer;
        z-index: 1050;
        transition: all 0.25s ease;
        backdrop-filter: blur(6px);
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
    }

    .btn-volver-top:hover {
        background: #ff253c;
        color: #fff;
        transform: scale(1.05);
        box-shadow: 0 0 20px rgba(255, 37, 60, 0.4);
    }

    .btn-volver-top i {
        font-size: 1.2rem;
    }

</style>

<!-- Fondo -->
<div class="backdrop" style="background-image: url('@Model.Pelicula.PosterUrl')"></div>

<!-- Botón Volver -->
<button class="btn-volver-top" id="btnVolver">
    <i class="bi bi-arrow-left"></i> Volver
</button>

<div class="container">

    <!-- Panel izquierdo -->
    <div class="left-panel">
        <img src="@Model.Pelicula.PosterUrl" class="movie-poster" />
        <div class="movie-title">@Model.Pelicula.Nombre</div>
        <div class="details">@Model.Cine.Nombre – @Model.Cine.Direccion</div>
        <div class="details">@Model.Pelicula.Duracion min</div>
    </div>

    <!-- Panel derecho con scroll -->
    <div class="right-panel">
        <div class="date-selector d-flex gap-2 flex-wrap">
            @foreach (var f in Model.FechasDisponibles)
            {
                <a href="javascript:void(0);" class="date-link" data-fecha="@f">@DateTime.Parse(f).ToString("dd/MM")</a>
            }
        </div>

        <hr />

        <div id="horariosContainer"></div>
    </div>
</div>

<!-- Botón Comprar Entrada -->
<button id="buyButton" class="buy-button">Comprar Entrada</button>

<script>
    let proyeccionesPorFecha = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.ProyeccionesPorFecha));
    let fechaSeleccionada = null;
    let horaSeleccionada = null;
    let idProyeccionSeleccionado = null;
    let salaSeleccionada = null;

    function renderHorarios(fecha, horaRestaurar = null, salaRestaurar = null) {
        const container = document.getElementById('horariosContainer');
        container.innerHTML = '';

        const salas = proyeccionesPorFecha[fecha] || [];

        salas.forEach(sala => {
            const salaTitle = document.createElement('div');
            salaTitle.className = 'sala-title';
            salaTitle.innerText = sala.Sala;
            container.appendChild(salaTitle);

            const horariosDiv = document.createElement('div');
            horariosDiv.className = 'horarios-container';

            sala.Horarios.forEach(h => {
                const btn = document.createElement('button');
                btn.className = 'hour-button';
                btn.innerText = h.Hora;
                btn.dataset.idproyeccion = h.IdProyeccion;
                btn.dataset.sala = sala.Sala;

                if (horaRestaurar && salaRestaurar &&
                    h.Hora === horaRestaurar && sala.Sala === salaRestaurar) {
                    btn.classList.add('selected');
                    horaSeleccionada = h.Hora;
                    idProyeccionSeleccionado = h.IdProyeccion;
                    salaSeleccionada = sala.Sala;
                }

                btn.addEventListener('click', () => {
                    document.querySelectorAll('.hour-button').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                    horaSeleccionada = h.Hora;
                    idProyeccionSeleccionado = h.IdProyeccion;
                    salaSeleccionada = sala.Sala;
                    checkShowBuyButton();
                });

                horariosDiv.appendChild(btn);
            });

            container.appendChild(horariosDiv);
        });

        checkShowBuyButton();
    }

    document.querySelectorAll('.date-link').forEach(link => {
        link.addEventListener('click', () => {
            document.querySelectorAll('.date-link').forEach(l => l.classList.remove('active'));
            link.classList.add('active');
            fechaSeleccionada = link.dataset.fecha;
            horaSeleccionada = null;
            idProyeccionSeleccionado = null;
            salaSeleccionada = null;
            renderHorarios(fechaSeleccionada);
        });
    });

    function checkShowBuyButton() {
        const btn = document.getElementById('buyButton');
        btn.style.display = (fechaSeleccionada && horaSeleccionada) ? 'block' : 'none';
    }

    document.getElementById('buyButton').addEventListener('click', () => {
        if (!idProyeccionSeleccionado) return;

        const form = document.createElement('form');
        form.method = 'get';
        form.action = '@Url.Action("Index", "VentaEntradas")';
        form.innerHTML = `<input type="hidden" name="idProyeccion" value="${idProyeccionSeleccionado}">`;
        document.body.appendChild(form);
        form.submit();
    });

    window.addEventListener("DOMContentLoaded", () => {
        const desdeVenta = "@(ViewBag.DesdeVenta ?? false)".toLowerCase() === "true";
        if (!desdeVenta) return;

        let fechaRestauradaRaw = "@(ViewBag.FechaSeleccionada ?? "")";
        const horaRestaurada = "@(ViewBag.HoraSeleccionada ?? "")";
        const salaRestaurada = "@(ViewBag.SalaSeleccionada ?? "")";

        let fechaRestaurada = "";
        if (fechaRestauradaRaw.includes("/")) {
            try {
                const partes = fechaRestauradaRaw.split(" ")[0].split("/");
                const dia = partes[0].padStart(2, "0");
                const mes = partes[1].padStart(2, "0");
                const anio = partes[2];
                fechaRestaurada = `${anio}-${mes}-${dia}`;
            } catch {}
        } else {
            fechaRestaurada = fechaRestauradaRaw;
        }

        const link = document.querySelector(`.date-link[data-fecha="${fechaRestaurada}"]`);
        if (!link) return;

        link.classList.add("active");
        fechaSeleccionada = fechaRestaurada;

        renderHorarios(fechaRestaurada, horaRestaurada, salaRestaurada);
    });

    document.getElementById("btnVolver").addEventListener("click", () => {
        window.location.href = "/";
    });
</script>
