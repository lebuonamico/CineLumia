@model Cine_Lumia.Models.ViewModel.FuncionesViewModel

@{
    // Helper para resolver poster similar al usado en Home (más robusto)
    Func<string, string, string> ResolvePoster = (path, titulo) =>
    {
        var placeholder = Url.Content("~/images/placeholder-movie.png");
        try
        {
            var env = Context.RequestServices.GetService(typeof(Microsoft.AspNetCore.Hosting.IWebHostEnvironment)) as Microsoft.AspNetCore.Hosting.IWebHostEnvironment;
            var folder = env != null ? System.IO.Path.Combine(env.WebRootPath, "images", "peliculas") : null;

            // Normalizar título en varias formas para comparar con nombres de archivo
            var titleRaw = (titulo ?? "").ToLowerInvariant();
            var titleOnlyAlnum = System.Text.RegularExpressions.Regex.Replace(titleRaw, "[^a-z0-9]", ""); // sin espacios ni signos
            var titleKeepSpaces = System.Text.RegularExpressions.Regex.Replace(titleRaw, "[^a-z0-9\\s]", ""); // mantiene espacios
            var slug = System.Text.RegularExpressions.Regex.Replace(titleKeepSpaces, "\\s+", "-");

            // 1) intentar encontrar por título en filenames locales (contenga slug, contenga words, o compact match)
            if (!string.IsNullOrWhiteSpace(titulo) && folder != null && System.IO.Directory.Exists(folder))
            {
                var files = System.IO.Directory.GetFiles(folder);
                var match = files.FirstOrDefault(f =>
                {
                    var name = System.IO.Path.GetFileNameWithoutExtension(f).ToLowerInvariant();
                    var nameCompact = System.Text.RegularExpressions.Regex.Replace(name, "[^a-z0-9]", "");

                    if (!string.IsNullOrWhiteSpace(slug) && name.Contains(slug)) return true;
                    if (!string.IsNullOrWhiteSpace(titleKeepSpaces) && name.Contains(titleKeepSpaces)) return true;
                    if (!string.IsNullOrWhiteSpace(titleOnlyAlnum) && nameCompact.Contains(titleOnlyAlnum)) return true;
                    return false;
                });

                if (match != null)
                    return Url.Content("~/images/peliculas/" + System.IO.Path.GetFileName(match));
            }

            // 2) si path es vacío devolvemos placeholder
            if (string.IsNullOrWhiteSpace(path)) return placeholder;

            // 3) si path es absoluta (http/https) devolverla pero antes intentar localizar archivo local por basename
            if (path.StartsWith("http://") || path.StartsWith("https://"))
            {
                if (folder != null && System.IO.Directory.Exists(folder))
                {
                    var baseNoExt = System.IO.Path.GetFileNameWithoutExtension(path).ToLowerInvariant();
                    var matches = System.IO.Directory.GetFiles(folder)
                        .Where(f => System.IO.Path.GetFileNameWithoutExtension(f).ToLowerInvariant() == baseNoExt)
                        .ToList();
                    if (matches.Any()) return Url.Content("~/images/peliculas/" + System.IO.Path.GetFileName(matches.First()));
                }

                return path;
            }

            // 4) normalizar ruta relativa y comprobar existencia física
            string relative = path;
            if (relative.StartsWith("~")) relative = relative.Substring(1);
            if (relative.StartsWith("/")) relative = relative.Substring(1);

            if (env != null)
            {
                var physical = System.IO.Path.Combine(env.WebRootPath, relative.Replace('/', System.IO.Path.DirectorySeparatorChar));
                if (System.IO.File.Exists(physical))
                {
                    return Url.Content("~/" + relative);
                }
            }

            // 5) intentar por nombre de archivo dentro de images/peliculas a partir del valor de path
            if (folder != null && System.IO.Directory.Exists(folder))
            {
                var fileNameNoExt = System.IO.Path.GetFileNameWithoutExtension(relative).ToLowerInvariant();
                var matches = System.IO.Directory.GetFiles(folder)
                    .Where(f => System.IO.Path.GetFileNameWithoutExtension(f).ToLowerInvariant() == fileNameNoExt)
                    .ToList();

                if (matches.Any())
                {
                    return Url.Content("~/images/peliculas/" + System.IO.Path.GetFileName(matches.First()));
                }
            }

            // 6) fallback
            return placeholder;
        }
        catch
        {
            return placeholder;
        }
    };

    // calcular posterUrl para reusar
    var posterUrlResolved = ResolvePoster(Model.Pelicula?.PosterUrl, Model.Pelicula?.Nombre ?? "");
}

<style>
    body {
        background: #0d0d0d !important;
        color: #fff !important;
        font-family: 'Segoe UI', sans-serif;
        margin: 0;
    }

    .backdrop {
        position: fixed;
        inset: 0;
        background-size: cover;
        background-position: center;
        filter: blur(40px) brightness(.25);
        z-index: -1;
    }

    .container {
        display: flex;
        gap: 40px;
        max-width: 1200px;
        margin: 50px auto;
        padding: 0 20px;
    }

    .left-panel {
        width: 340px;
        flex-shrink: 0;
    }

    .movie-poster {
        width: 100%;
        height: 510px;
        border-radius: 14px;
        object-fit: cover;
        box-shadow: 0 0 50px rgba(0,0,0,.9);
    }

    .movie-title {
        font-size: 2rem;
        font-weight: 700;
        margin-top: 20px;
    }

    .details {
        color: #cfcfcf;
        margin-top: 6px;
    }

    .right-panel {
        flex: 1;
        display: flex;
        flex-direction: column;
        max-height: 600px;
        overflow-y: auto;
        padding-right: 10px;
    }

    .date-selector a {
        padding: 10px 18px;
        border-radius: 8px;
        text-decoration: none;
        border: 1px solid #ff253c;
        color: #ff253c;
        font-weight: 600;
        transition: .25s;
        display: inline-block;
        margin: 4px;
    }

        .date-selector a.active,
        .date-selector a:hover {
            background: #ff253c;
            color: #fff;
        }

    .sala-title {
        font-size: 1.2rem;
        font-weight: 600;
        margin-top: 20px;
        margin-bottom: 8px;
        text-transform: uppercase;
    }

    .horarios-container {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin-bottom: 20px;
    }

    .hour-button {
        padding: 10px 20px;
        border-radius: 40px;
        border: 1px solid #ff253c;
        font-weight: 600;
        background: #0a0a0a;
        color: #ffffff;
        cursor: pointer;
        transition: .25s;
        display: flex;
        align-items: center;
        justify-content: center;
    }

        .hour-button:hover,
        .hour-button.selected {
            background: #ff253c;
            color: #fff;
            transform: scale(1.05);
        }

        .hour-button.disabled {
            border-color: #555;
            color: #777;
            background: #1a1a1a;
            cursor: not-allowed;
            pointer-events: none;
            opacity: 0.6;
        }

    .buy-button {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        padding: 18px 0;
        background: #ff253c;
        color: #fff;
        text-align: center;
        font-size: 1.4rem;
        font-weight: 700;
        border: none;
        cursor: pointer;
        display: none;
        transition: .25s;
        z-index: 999;
    }

        .buy-button:hover {
            background: #e81e34;
        }

    .btn-volver-top {
        position: fixed;
        top: 90px;
        left: 40px;
        display: flex;
        align-items: center;
        gap: 8px;
        background: rgba(0, 0, 0, 0.75);
        border: 1px solid #ff253c;
        color: #ff253c;
        font-weight: 600;
        font-size: 1rem;
        padding: 10px 22px;
        border-radius: 40px;
        cursor: pointer;
        z-index: 1050;
        transition: all 0.25s ease;
        backdrop-filter: blur(6px);
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
    }

        .btn-volver-top:hover {
            background: #ff253c;
            color: #fff;
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(255, 37, 60, 0.4);
        }

        .btn-volver-top i {
            font-size: 1.2rem;
        }
</style>

<!-- Fondo difuminado -->
<div class="backdrop" style="background-image: url('@posterUrlResolved')"></div>

<!-- Botón Volver -->
<button class="btn-volver-top" id="btnVolver">
    <i class="bi bi-arrow-left"></i> Volver
</button>

<div class="container">
    <!-- Panel izquierdo -->
    <div class="left-panel">
        <img src="@posterUrlResolved" class="movie-poster" />
        <div class="movie-title">@Model.Pelicula.Nombre</div>
        <div class="details">@Model.Cine.Nombre – @Model.Cine.Direccion</div>
        <div class="details">@Model.Pelicula.Duracion min</div>
    </div>

    <!-- Panel derecho -->
    <div class="right-panel">
        <div class="date-selector d-flex gap-2 flex-wrap">
            @foreach (var f in Model.FechasDisponibles)
            {
                <a href="javascript:void(0);" class="date-link" data-fecha="@f">@DateTime.Parse(f).ToString("dd/MM")</a>
            }
        </div>

        <hr />
        <div id="horariosContainer"></div>
    </div>
</div>

<!-- Botón Comprar -->
<button id="buyButton" class="buy-button">Comprar Entrada</button>

<script>
    console.log('Funciones: script start');
    let proyeccionesPorFecha = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(
                                 Model.ProyeccionesPorFecha,
                                 new System.Text.Json.JsonSerializerOptions { PropertyNamingPolicy = null }
                 ));

    let fechaSeleccionada = null;
    let horaSeleccionada = null;
    let idProyeccionSeleccionado = null;
    let salaSeleccionada = null;

    function renderHorarios(fecha) {
        const container = document.getElementById('horariosContainer');
        container.innerHTML = '';
        console.log('renderHorarios for', fecha);

        const salas = proyeccionesPorFecha[fecha] || [];

        salas.forEach(sala => {
            const salaTitle = document.createElement('div');
            salaTitle.className = 'sala-title';
            salaTitle.innerText = sala.Sala;
            container.appendChild(salaTitle);

            const horariosDiv = document.createElement('div');
            horariosDiv.className = 'horarios-container';

            sala.Horarios.forEach(h => {
                const btn = document.createElement('button');
                btn.className = 'hour-button';
                btn.dataset.idproyeccion = h.IdProyeccion;
                btn.dataset.sala = sala.Sala;
    // 🎬 Crear el ícono SVG tipo Hoyts
    const icon = document.createElementNS("http://www.w3.org/2000/svg", "svg");
    icon.setAttribute("viewBox", "0 0 24 24");
    icon.setAttribute("width", "24");
    icon.setAttribute("height", "24");
    icon.style.marginRight = "8px";
    icon.style.transition = "color 0.3s ease, transform 0.2s";

    const path1 = document.createElementNS("http://www.w3.org/2000/svg", "path");
    path1.setAttribute("d", "M4.08443 6.13605L7.45847 15.9402C7.58758 16.255 7.94118 16.4187 8.26759 16.3076C8.60682 16.1922 8.78822 15.8236 8.67276 15.4844L7.00024 10.6687L6.99995 10.6679C6.63017 9.59686 7.42571 8.48056 8.55875 8.48056H9.34171C9.54211 8.48056 9.65597 8.25124 9.53484 8.0916L6.91735 4.64199C6.61047 4.23755 6.13203 4 5.62434 4C4.51662 4 3.73435 5.08511 4.08443 6.13605Z");
    path1.setAttribute("fill", "currentColor");

    const path2 = document.createElementNS("http://www.w3.org/2000/svg", "path");
    path2.setAttribute("d", "M10.4242 18.7879C10.4242 18.654 10.5328 18.5455 10.6667 18.5455H19.7576C19.8915 18.5455 20 18.654 20 18.7879V19.3939C20 19.7287 19.7287 20 19.3939 20H11.0303C10.6956 20 10.4242 19.7287 10.4242 19.3939V18.7879Z");
    path2.setAttribute("fill", "currentColor");

    const path3 = document.createElementNS("http://www.w3.org/2000/svg", "path");
    path3.setAttribute("d", "M8.4283 9.44504C8.0113 9.4476 7.7214 9.86075 7.86085 10.2538L7.88999 10.3359L10.2235 17.1657C10.3073 17.4109 10.5378 17.5758 10.797 17.5758H19.3882C19.3901 17.5758 19.392 17.5758 19.3939 17.5757C19.8083 17.572 20.0975 17.1617 19.9602 16.7695L19.3939 15.1515L19.3904 15.1501L17.5942 9.80533C17.5109 9.55728 17.2777 9.39075 17.016 9.39235L8.4283 9.44504Z");
    path3.setAttribute("fill", "currentColor");

    icon.appendChild(path1);
    icon.appendChild(path2);
    icon.appendChild(path3);


                    // 🎨 Cambiar color del ícono según disponibilidad
    if (h.Disponibles === 0) {
        [path1, path2, path3].forEach(p => p.setAttribute("fill", "#ff3b3b")); // 🔴 rojo
        btn.classList.add('disabled');
        btn.title = "Agotado";
    } else {
        const ratio = h.Disponibles / h.TotalAsientos;
        if (ratio > 0.5) {
            [path1, path2, path3].forEach(p => p.setAttribute("fill", "#00ff6a")); // 🟢 verde
            btn.title = "Alta disponibilidad";
        } else {
            [path1, path2, path3].forEach(p => p.setAttribute("fill", "#ffcc00")); // 🟡 amarillo
            btn.title = "Disponibilidad media";
        }
    }


                const text = document.createTextNode(` ${h.Hora}`);
                btn.appendChild(icon);
                btn.appendChild(text);

                if (h.Disponibles > 0) {
                    btn.addEventListener('click', () => {
                        console.log('hour button clicked', { hora: h.Hora, idProyeccion: h.IdProyeccion, sala: sala.Sala });
                        document.querySelectorAll('.hour-button').forEach(b => b.classList.remove('selected'));
                        btn.classList.add('selected');
                        horaSeleccionada = h.Hora;
                        idProyeccionSeleccionado = h.IdProyeccion;
                        salaSeleccionada = sala.Sala;
                        checkShowBuyButton();
                    });
                }

                horariosDiv.appendChild(btn);
            });

            container.appendChild(horariosDiv);
        });

        checkShowBuyButton();
    }

        document.querySelectorAll('.date-link').forEach(link => {
        link.addEventListener('click', () => {
            document.querySelectorAll('.date-link').forEach(l => l.classList.remove('active'));
            link.classList.add('active');
            fechaSeleccionada = link.dataset.fecha;

            // 🔄 Reiniciar selección al cambiar de fecha
            horaSeleccionada = null;
            idProyeccionSeleccionado = null;
            salaSeleccionada = null;
            checkShowBuyButton();

            renderHorarios(fechaSeleccionada);
        });
    });


    function checkShowBuyButton() {
        const btn = document.getElementById('buyButton');
        const shouldShow = (fechaSeleccionada && horaSeleccionada);
        btn.style.display = shouldShow ? 'block' : 'none';
        console.log('checkShowBuyButton', { fechaSeleccionada, horaSeleccionada, idProyeccionSeleccionado, shouldShow });
     }
 
    (function attachBuy() {
        const buyBtn = document.getElementById('buyButton');
        if (!buyBtn) { console.warn('buyButton not found'); return; }
        buyBtn.addEventListener('click', (ev) => {
            console.log('buyButton clicked', { idProyeccionSeleccionado, fechaSeleccionada, horaSeleccionada });
            if (!idProyeccionSeleccionado) {
                console.warn('No proyeccion selected, aborting');
                return;
            }

            const form = document.createElement('form');
            form.method = 'post';
            form.action = '/Funciones/SeleccionarProyeccionOculta';
            form.innerHTML = `<input type="hidden" name="idProyeccion" value="${idProyeccionSeleccionado}">`;
            document.body.appendChild(form);
            console.log('Submitting hidden form to', form.action);
            form.submit();
        });
    })();

        window.addEventListener("DOMContentLoaded", () => {
        const desdeVenta = "@(ViewBag.DesdeVenta ?? false)".toLowerCase() === "true";
        if (!desdeVenta) {
            // Si no viene desde VentaEntradas, cargar la primera fecha normalmente
            document.querySelector('.date-link')?.click();
            return;
        }

        // 🔹 Restaurar datos guardados
        let fechaRestauradaRaw = "@(ViewBag.FechaSeleccionada ?? "")";
        const horaRestaurada = "@(ViewBag.HoraSeleccionada ?? "")";
        const salaRestaurada = "@(ViewBag.SalaSeleccionada ?? "")";

        let fechaRestaurada = "";
        if (fechaRestauradaRaw.includes("/")) {
            try {
                const partes = fechaRestauradaRaw.split(" ")[0].split("/");
                const dia = partes[0].padStart(2, "0");
                const mes = partes[1].padStart(2, "0");
                const anio = partes[2];
                fechaRestaurada = `${anio}-${mes}-${dia}`;
            } catch {}
        } else {
            fechaRestaurada = fechaRestauradaRaw;
        }

        // 🔹 Activar visualmente la fecha seleccionada
        const link = document.querySelector(`.date-link[data-fecha="${fechaRestaurada}"]`);
        if (!link) return;

        link.classList.add("active");
        fechaSeleccionada = fechaRestaurada;

        // 🔹 Renderizar los horarios y restaurar hora/sala
        renderHorarios(fechaRestaurada);

        // Esperar un poco a que se dibujen los botones antes de seleccionar
        setTimeout(() => {
            document.querySelectorAll(".hour-button").forEach(btn => {
                if (btn.innerText.trim() === horaRestaurada && btn.dataset.sala === salaRestaurada) {
                    btn.classList.add("selected");
                    horaSeleccionada = horaRestaurada;
                    idProyeccionSeleccionado = btn.dataset.idproyeccion;
                    salaSeleccionada = salaRestaurada;
                }
            });
            checkShowBuyButton();
        }, 150);
    });


    document.getElementById("btnVolver").addEventListener("click", () => {
        window.location.href = "/";
    });
 </script>

