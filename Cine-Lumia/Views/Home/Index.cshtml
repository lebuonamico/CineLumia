@using Cine_Lumia.Models.ViewModel
@model HomeViewModel

@{
    ViewData["Title"] = "Inicio - Cine Lumia";

    // Helper para resolver la URL del poster (acepta rutas que empiecen con ~ o / o rutas completas)
    Func<string, string, string> ResolvePoster = (path, titulo) =>
    {
        var placeholder = Url.Content("~/images/placeholder-movie.png");
        try
        {
            var env = Context.RequestServices.GetService(typeof(Microsoft.AspNetCore.Hosting.IWebHostEnvironment)) as Microsoft.AspNetCore.Hosting.IWebHostEnvironment;
            var folder = env != null ? System.IO.Path.Combine(env.WebRootPath, "images", "peliculas") : null;

            // Normalizar título en varias formas para comparar con nombres de archivo
            var titleRaw = (titulo ?? "").ToLowerInvariant();
            var titleOnlyAlnum = System.Text.RegularExpressions.Regex.Replace(titleRaw, "[^a-z0-9]", ""); // sin espacios ni signos
            var titleKeepSpaces = System.Text.RegularExpressions.Regex.Replace(titleRaw, "[^a-z0-9\\s]", ""); // mantiene espacios
            var slug = System.Text.RegularExpressions.Regex.Replace(titleKeepSpaces, "\\s+", "-");

            // 1) intentar encontrar por título en filenames locales (contenga slug, contenga words, o compact match)
            if (!string.IsNullOrWhiteSpace(titulo) && folder != null && System.IO.Directory.Exists(folder))
            {
                var files = System.IO.Directory.GetFiles(folder);
                var match = files.FirstOrDefault(f =>
                {
                    var name = System.IO.Path.GetFileNameWithoutExtension(f).ToLowerInvariant();
                    var nameCompact = System.Text.RegularExpressions.Regex.Replace(name, "[^a-z0-9]", "");

                    if (!string.IsNullOrWhiteSpace(slug) && name.Contains(slug)) return true;
                    if (!string.IsNullOrWhiteSpace(titleKeepSpaces) && name.Contains(titleKeepSpaces)) return true;
                    if (!string.IsNullOrWhiteSpace(titleOnlyAlnum) && nameCompact.Contains(titleOnlyAlnum)) return true;
                    return false;
                });

                if (match != null)
                    return Url.Content("~/images/peliculas/" + System.IO.Path.GetFileName(match));
            }

            // 2) si path es vacío devolvemos placeholder
            if (string.IsNullOrWhiteSpace(path)) return placeholder;

            // 3) si path es absoluta (http/https) devolverla pero antes intentar localizar archivo local por basename
            if (path.StartsWith("http://") || path.StartsWith("https://"))
            {
                if (folder != null && System.IO.Directory.Exists(folder))
                {
                    var baseNoExt = System.IO.Path.GetFileNameWithoutExtension(path).ToLowerInvariant();
                    var matches = System.IO.Directory.GetFiles(folder)
                        .Where(f => System.IO.Path.GetFileNameWithoutExtension(f).ToLowerInvariant() == baseNoExt)
                        .ToList();
                    if (matches.Any()) return Url.Content("~/images/peliculas/" + System.IO.Path.GetFileName(matches.First()));
                }

                return path;
            }

            // 4) normalizar ruta relativa y comprobar existencia física
            string relative = path;
            if (relative.StartsWith("~")) relative = relative.Substring(1);
            if (relative.StartsWith("/")) relative = relative.Substring(1);

            if (env != null)
            {
                var physical = System.IO.Path.Combine(env.WebRootPath, relative.Replace('/', System.IO.Path.DirectorySeparatorChar));
                if (System.IO.File.Exists(physical))
                {
                    return Url.Content("~/" + relative);
                }
            }

            // 5) intentar por nombre de archivo dentro de images/peliculas a partir del valor de path
            if (folder != null && System.IO.Directory.Exists(folder))
            {
                var fileNameNoExt = System.IO.Path.GetFileNameWithoutExtension(relative).ToLowerInvariant();
                var matches = System.IO.Directory.GetFiles(folder)
                    .Where(f => System.IO.Path.GetFileNameWithoutExtension(f).ToLowerInvariant() == fileNameNoExt)
                    .ToList();

                if (matches.Any())
                {
                    return Url.Content("~/images/peliculas/" + System.IO.Path.GetFileName(matches.First()));
                }
            }

            // 6) fallback
            return placeholder;
        }
        catch
        {
            return placeholder;
        }
    };

    // Determinar banners a mostrar (se mantiene lógica previa)
    var banners = new List<string>();
    try
    {
        var env = Context.RequestServices.GetService(typeof(Microsoft.AspNetCore.Hosting.IWebHostEnvironment)) as Microsoft.AspNetCore.Hosting.IWebHostEnvironment;
        if (env != null)
        {
            var bannerDir = System.IO.Path.Combine(env.WebRootPath, "images", "banner");
            if (System.IO.Directory.Exists(bannerDir))
            {
                banners = System.IO.Directory.GetFiles(bannerDir)
                    .Where(f => new[] { ".png", ".jpg", ".jpeg", ".webp", ".gif" }
                        .Contains(System.IO.Path.GetExtension(f).ToLowerInvariant()))
                    .Select(f => "/images/banner/" + System.IO.Path.GetFileName(f))
                    .ToList();
            }
        }
    }
    catch { }

    var bannerCount = Math.Min(3, banners.Count);

    // Generos disponibles para filtro
    var generosDisponibles = Model.Cartelera
        .SelectMany(p => p.PeliculaGeneros.Select(pg => pg.Genero.GeneroNombre))
        .Distinct()
        .OrderBy(g => g)
        .ToList();
}

<style>
    /* Asegurar que el carrusel es solo para su seccion y que sus controles esten dentro de el */
    .carousel-wrapper { position: relative; margin-top: 0.5rem; margin-bottom: 1.5rem; z-index: 1; }
    #carouselBanner { position: relative; }
    #carouselBanner .carousel-control-prev, #carouselBanner .carousel-control-next { z-index: 1020; width: 4rem; }
    #carouselBanner .carousel-inner img { width: 100%; height: 420px; object-fit: cover; }
    #carouselBanner .carousel-control-prev-icon, #carouselBanner .carousel-control-next-icon { filter: invert(1) brightness(2) !important; }

    /* Filtro genero */
    .genre-filter { margin: 12px 0 18px; display: flex; align-items: center; gap: 12px; }
    .genre-filter select { background:#111; color:#fff; border:1px solid rgba(255,255,255,0.08); padding:8px 12px; border-radius:8px; }

    /* Salas badges */
    .salas-list { margin-bottom: 0.75rem; }
    .salas-list .badge-sala { display: inline-block; background: transparent; border: 1px solid rgba(255,255,255,0.12); color: #fff; padding: 4px 8px; border-radius: 999px; font-size: 0.8rem; margin-right: 6px; }
    .movie-meta { color: #bdb6b0; font-size: 0.95rem; margin-bottom: .5rem; }

    /* Card clickable */
    .card-clickable {
        cursor: pointer;
        transition: transform 0.2s;
    }
    .card-clickable:hover {
        transform: scale(1.02);
    }

    /* Poster image in card */
    .poster-card {
        height: 360px;
        object-fit: cover;
    }
</style>

<div class="container">
    <!-- BANNERS / SLIDER (publicidad) -->
    @if (bannerCount > 0)
    {
        <div class="carousel-wrapper">
            <div id="carouselBanner" class="carousel slide" data-bs-ride="carousel">
                <div class="carousel-inner rounded shadow-sm">
                    @for (int i = 0; i < bannerCount; i++)
                    {
                        var src = banners[i];
                        <div class="carousel-item @(i == 0 ? "active" : "")">
                            <img src="@Url.Content(src)" onerror="this.onerror=null;this.src='@Url.Content("~/images/placeholder-movie.png")';" class="d-block w-100" alt="Banner @(i + 1)" />
                        </div>
                    }
                </div>

                <button class="carousel-control-prev" type="button" data-bs-target="#carouselBanner" data-bs-slide="prev">
                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">Anterior</span>
                </button>
                <button class="carousel-control-next" type="button" data-bs-target="#carouselBanner" data-bs-slide="next">
                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">Siguiente</span>
                </button>
            </div>
        </div>
    }

    <!-- CARTELERA -->
    <section class="mt-5">
        <h3 class="mb-2">Cartelera</h3>

        <!-- Filtro por género -->
        <div class="genre-filter">
            <label class="small text-muted mb-0">Género</label>
            <select id="filterGenero">
                <option value="">Todos</option>
                @foreach (var g in generosDisponibles)
                {
                    <option value="@g">@g</option>
                }
            </select>
        </div>

        <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 g-4" id="carteleraGrid">
            @foreach (var pelicula in Model.Cartelera)
            {
                var posterUrl = ResolvePoster(pelicula.PosterUrl, pelicula.Nombre);
                var generosAttr = string.Join(",", pelicula.PeliculaGeneros.Select(pg => pg.Genero.GeneroNombre));
                <div class="col pelicula-card" data-generos="@generosAttr">
                    <form method="post" action="@Url.Action("VerFunciones", "Peliculas")" class="card-form" data-pelicula="@pelicula.Id_Pelicula">
                        <input type="hidden" name="peliculaId" value="@pelicula.Id_Pelicula" />
                        <div class="card h-100 shadow-sm card-clickable" role="button" tabindex="0">
                            <img src="@posterUrl" onerror="this.onerror=null;this.src='@Url.Content("~/images/placeholder-movie.png")';" class="card-img-top poster-card" alt="@pelicula.Nombre" style="height:360px; object-fit:cover;" />
                            <div class="card-body d-flex flex-column">
                                <!-- Nombre de la pelicula -->
                                <h5 class="card-title mb-1">@pelicula.Nombre</h5>

                                <!-- Genero - Duracion -->
                                <div class="movie-meta">@string.Join(", ", pelicula.PeliculaGeneros.Select(pg => pg.Genero.GeneroNombre)) - @pelicula.Duracion min</div>

                                <!-- Salas disponibles para esta pelicula (rellenado por JS) -->
                                <div class="salas-list mt-2" data-pelicula-id="@pelicula.Id_Pelicula">&nbsp;</div>

                            </div>
                        </div>
                    </form>
                </div>
            }
        </div>
    </section>
</div>

@section Scripts {
    <script>
        var myCarousel = document.querySelector('#carouselBanner');
        if (myCarousel) {
            var carousel = new bootstrap.Carousel(myCarousel, { interval: 5000 });
        }

        // Filtrado cliente por género
        const filterGenero = document.getElementById('filterGenero');
        const carteleraGrid = document.getElementById('carteleraGrid');

        function matchesGenero(card) {
            const genFilter = (filterGenero.value || '').toLowerCase();
            if (!genFilter) return true;
            const generos = (card.dataset.generos || '').toLowerCase();
            return generos.split(',').map(g => g.trim()).includes(genFilter);
        }

        function applyGeneroFilter() {
            document.querySelectorAll('#carteleraGrid .pelicula-card').forEach(card => {
                card.style.display = matchesGenero(card) ? 'block' : 'none';
            });
        }

        filterGenero?.addEventListener('change', applyGeneroFilter);

        // Cache de salas por pelicula+cine para evitar llamadas repetidas
        var salasCache = {};

        function renderSalasForAll() {
            document.querySelectorAll('.salas-list').forEach(function (el) {
                var peliculaId = el.dataset.peliculaId;
                renderSalas(peliculaId, el);
            });
        }

        async function renderSalas(peliculaId, containerEl) {
            // show loading
            containerEl.innerHTML = '<span class="text-muted small">Cargando salas...</span>';

            var cineSeleccionado = localStorage.getItem('cineSeleccionado');
            var cacheKey = peliculaId + '|' + (cineSeleccionado || 'all');
            if (salasCache[cacheKey]) {
                buildBadges(salasCache[cacheKey], containerEl);
                return;
            }

            var url = '/Cines/SalasPorPelicula?peliculaId=' + encodeURIComponent(peliculaId);
            if (cineSeleccionado) url += '&cineId=' + encodeURIComponent(cineSeleccionado);

            try {
                var response = await fetch(url);
                if (!response.ok) throw new Error('Network error');
                var data = await response.json();

                data = (data || []).map(function (d) {
                    return {
                        IdSala: d.IdSala || d.idSala || 0,
                        Formato: d.Formato || d.formato || ''
                    };
                });

                if ((data == null || data.length === 0) && cineSeleccionado) {
                    var fallbackUrl = '/Cines/SalasPorPelicula?peliculaId=' + encodeURIComponent(peliculaId);
                    var r2 = await fetch(fallbackUrl);
                    if (r2.ok) {
                        data = await r2.json();
                        data = (data || []).map(function (d) {
                            return {
                                IdSala: d.IdSala || d.idSala || 0,
                                Formato: d.Formato || d.formato || ''
                            };
                        });
                    }
                }

                salasCache[cacheKey] = data || [];
                buildBadges(salasCache[cacheKey], containerEl);
            } catch (e) {
                containerEl.innerHTML = '<span class="text-muted small">Sin salas</span>';
            }
        }

        function buildBadges(salas, containerEl) {
            if (!salas || salas.length === 0) {
                containerEl.innerHTML = '<span class="text-muted small">Sin salas</span>';
                return;
            }
            
            var formatos = salas.map(function (s) {
                return s.Formato || s.formato || '';
            });

            var uniqueFormatos = [...new Set(formatos)].filter(f => f);

            var html = '';
            uniqueFormatos.forEach(function (formato) {
                html += '<span class="badge-sala">' + escapeHtml(formato) + '</span>';
            });

            containerEl.innerHTML = html;
        }

        function escapeHtml(unsafe) {
            return unsafe.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/\"/g, "&quot;").replace(/'/g, "&#039;");
        }

        (function () {
            var serverError = '@(TempData["ErrorSeleccionCine"] as string)';
            if (serverError && serverError.length > 0) {
                Swal.fire({ icon: 'warning', title: 'Atención', text: serverError });
            }

            var successMessage = '@(TempData["SuccessMessage"] as string)';
            if (successMessage && successMessage.length > 0) {
                Swal.fire({
                    icon: 'success',
                    title: 'Cuenta Eliminada',
                    text: successMessage,
                    confirmButtonText: 'Aceptar'
                });
            }
        })();

        document.addEventListener('DOMContentLoaded', function () { renderSalasForAll(); });
        document.addEventListener('click', function (e) {
            if (e.target && (e.target.id === 'btnSeleccionar' || e.target.closest('#btnSeleccionar'))) {
                setTimeout(function () { renderSalasForAll(); }, 150);
            }
        });

        // Submit form on card click
        document.querySelectorAll('.card-clickable').forEach(function (card) {
            card.addEventListener('click', function () {
                var form = this.closest('form.card-form');
                if (!form) return;

                var cineSeleccionado = localStorage.getItem('cineSeleccionado');
                if (!cineSeleccionado) {
                    var offcanvasEl = document.getElementById('offcanvasCines');
                    if (offcanvasEl) {
                        var off = bootstrap.Offcanvas.getOrCreateInstance(offcanvasEl);
                        off.show();
                    }
                    return;
                }

                var inputCine = form.querySelector('input[name="cineId"]');
                if (!inputCine) {
                    inputCine = document.createElement('input');
                    inputCine.type = 'hidden';
                    inputCine.name = 'cineId';
                    form.appendChild(inputCine);
                }
                inputCine.value = cineSeleccionado;
                form.submit();
            });

            // Allow keyboard activation (Enter / Space)
            card.addEventListener('keydown', function (e) {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    this.click();
                }
            });
        });
    </script>
}
